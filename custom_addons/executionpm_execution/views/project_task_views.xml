<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Inherit Task Form View (Execution Progress) -->
    <record id="view_task_form_inherit_executionpm_progress" model="ir.ui.view">
        <field name="name">project.task.form.inherit.executionpm.progress</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="executionpm_planning.view_task_form_inherit_executionpm_base"/>
        <field name="arch" type="xml">
            <!-- 1. Hide the interactive status containers in the title area -->
            <xpath expr="//div[hasclass('o_state_container')]" position="attributes">
                <attribute name="invisible">execution_planning_task_id != False</attribute>
            </xpath>
            <xpath expr="//div[hasclass('o_state_container')][2]" position="attributes">
                <attribute name="invisible">execution_planning_task_id != False</attribute>
            </xpath>

            <!-- 2. Re-insert the status badge in the EXACT position of the old ribbon (Top Right of Title) -->
            <xpath expr="//h1" position="inside">
                <div class="d-flex justify-content-end align-items-center ms-auto" 
                     invisible="not execution_planning_task_id">
                    <field name="state" 
                           readonly="1" 
                           widget="badge"
                           decoration-info="state == '04_waiting_normal'"
                           decoration-success="state == '01_in_progress'"
                           decoration-primary="state == '1_done'"
                           class="o_task_state_widget"
                           style="padding: 4px 12px; border-radius: 12px;"/>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Kanban View for Execution Tasks (Grouped by Real Status) -->
    <record id="view_task_kanban_inherit_executionpm" model="ir.ui.view">
        <field name="name">project.task.kanban.inherit.executionpm</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <kanban position="attributes">
                <attribute name="default_group_by">execution_progress_status</attribute>
            </kanban>
        </field>
    </record>

    <!-- Specific Action for Execution Projects to use the new Kanban -->
    <record id="action_execution_project_tasks" model="ir.actions.act_window">
        <field name="name">Execution Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('execution_planning_task_id', '!=', False)]</field>
        <field name="context">{'default_display_in_project': True}</field>
        <field name="search_view_id" ref="project.view_task_search_form"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No execution tasks synchronized yet.
            </p>
            <p>
                Tasks will appear here once an Execution Planning is approved.
            </p>
        </field>
    </record>

</odoo>
