<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- 1. The Main Category - Resetting sequence and visibility -->
    <record id="module_category_executionpm" model="ir.module.category">
        <field name="name">Execution PM</field>
        <field name="parent_id" ref="base.module_category_services"/>
        <field name="sequence">50</field>
        <field name="visible" eval="False"/>
    </record>

    <!-- 2. The Groups -->
    
    <!-- Base Access - Hide from standard UI if possible by putting in Technical, 
         but we want checkboxes back, so let's put it in the main category as the first one -->
    <record id="group_executionpm_base" model="res.groups">
        <field name="name">Base Access</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
    </record>

    <record id="group_executionpm_contractor" model="res.groups">
        <field name="name">Contractor</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="group_executionpm_control_office" model="res.groups">
        <field name="name">Control Office</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="group_executionpm_pmo" model="res.groups">
        <field name="name">PMO</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_control_office'))]"/>
    </record>

    <record id="group_executionpm_authority" model="res.groups">
        <field name="name">Authority</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="group_executionpm_admin" model="res.groups">
        <field name="name">Administrator</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_pmo')), (4, ref('group_executionpm_authority'))]"/>
    </record>

    <!-- Rules are already correct in the file, keeping them as is -->
    
    <record id="rule_project_type_read_all" model="ir.rule">
        <field name="name">Execution Project Type: Read All</field>
        <field name="model_id" ref="model_execution_project_type"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="rule_project_type_admin" model="ir.rule">
        <field name="name">Execution Project Type: Admin Full Access</field>
        <field name="model_id" ref="model_execution_project_type"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <record id="rule_sector_read_all" model="ir.rule">
        <field name="name">Execution Sector: Read All</field>
        <field name="model_id" ref="model_execution_sector"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="rule_funding_source_read_all" model="ir.rule">
        <field name="name">Execution Funding Source: Read All</field>
        <field name="model_id" ref="model_execution_funding_source"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="rule_project_user" model="ir.rule">
        <field name="name">Execution Project: User Own Projects</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">['|', '|', '|', ('user_id', '=', user.id), ('create_uid', '=', user.id), ('message_partner_ids', 'in', [user.partner_id.id]), ('privacy_visibility', '=', 'portal')]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <record id="rule_project_manager" model="ir.rule">
        <field name="name">Execution Project: Manager Full Access</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_pmo'))]"/>
    </record>

    <record id="rule_authority_readonly_all" model="ir.rule">
        <field name="name">Authority: Global Read-Only Enforcement</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_authority'))]"/>
    </record>

    <record id="rule_project_contractor_own" model="ir.rule">
        <field name="name">Contractor: Own Projects Only</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[('execution_contractor_id.user_ids', 'in', user.id)]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_contractor'))]"/>
    </record>

    <!-- Administrator: Full Access Overrides (Ensures full dashboard access) -->
    <record id="rule_project_admin_all" model="ir.rule">
        <field name="name">Execution PM Admin: Project Full Access</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <record id="rule_attachment_admin_all" model="ir.rule">
        <field name="name">Execution PM Admin: Attachment Full Access</field>
        <field name="model_id" ref="base.model_ir_attachment"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <record id="rule_attachment_base_access" model="ir.rule">
        <field name="name">Execution PM: Read Linked Attachments</field>
        <field name="model_id" ref="base.model_ir_attachment"/>
        <field name="domain_force">['|', ('res_model', 'in', ['project.project', 'execution.planning', 'execution.progress']), ('public', '=', True)]</field>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

</odoo>
