<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================
         MODULE CATEGORY
    ================================================================= -->
    <record id="module_category_executionpm" model="ir.module.category">
        <field name="name">Execution PM</field>
        <field name="description">Execution Project Management for Infrastructure</field>
        <field name="sequence">50</field>
    </record>

    <!-- ================================================================
         SECURITY GROUPS
    ================================================================= -->
    
    <!-- Base Group: Global read access (implied by all other groups) -->
    <record id="group_executionpm_base" model="res.groups">
        <field name="name">User</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('base.group_user'))]"/>
    </record>

    <!-- Authority Group: Read-only access across the board -->
    <record id="group_executionpm_authority" model="res.groups">
        <field name="name">Authority (Read-Only)</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
        <field name="comment">Authorities have global read-only access to all projects and dashboards.</field>
    </record>

    <!-- Contractor Group: Can declare execution progress -->
    <record id="group_executionpm_contractor" model="res.groups">
        <field name="name">Contractor (Declare)</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
        <field name="comment">Contractors can declare execution progress for their assigned tasks.</field>
    </record>

    <!-- Control Office Group: Can review declarations -->
    <record id="group_executionpm_control_office" model="res.groups">
        <field name="name">Control Office (Review)</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_base'))]"/>
        <field name="comment">Control Office can review and submit comments on progress declarations.</field>
    </record>

    <!-- PMO Group: Can validate declarations -->
    <record id="group_executionpm_pmo" model="res.groups">
        <field name="name">PMO (Validate)</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_control_office'))]"/>
        <field name="comment">PMO can validate progress declarations and manage project planning.</field>
    </record>

    <!-- Administrator Group: Full system access -->
    <record id="group_executionpm_admin" model="res.groups">
        <field name="name">Administrator</field>
        <field name="category_id" ref="module_category_executionpm"/>
        <field name="implied_ids" eval="[(4, ref('group_executionpm_pmo')), (4, ref('group_executionpm_authority'))]"/>
        <field name="comment">Administrators can manage all settings and configurations.</field>
    </record>

    <!-- ================================================================
         RECORD RULES - Project Types (Configuration)
    ================================================================= -->
    
    <!-- All users can read project types -->
    <record id="rule_project_type_read_all" model="ir.rule">
        <field name="name">Execution Project Type: Read All</field>
        <field name="model_id" ref="model_execution_project_type"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <!-- Admins can manage project types -->
    <record id="rule_project_type_admin" model="ir.rule">
        <field name="name">Execution Project Type: Admin Full Access</field>
        <field name="model_id" ref="model_execution_project_type"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <!-- ================================================================
         RECORD RULES - Sectors (Configuration)
    ================================================================= -->
    
    <!-- All users can read sectors -->
    <record id="rule_sector_read_all" model="ir.rule">
        <field name="name">Execution Sector: Read All</field>
        <field name="model_id" ref="model_execution_sector"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <!-- Admins can manage sectors -->
    <record id="rule_sector_admin" model="ir.rule">
        <field name="name">Execution Sector: Admin Full Access</field>
        <field name="model_id" ref="model_execution_sector"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <!-- ================================================================
         RECORD RULES - Funding Sources (Configuration)
    ================================================================= -->
    
    <!-- All users can read funding sources -->
    <record id="rule_funding_source_read_all" model="ir.rule">
        <field name="name">Execution Funding Source: Read All</field>
        <field name="model_id" ref="model_execution_funding_source"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <!-- Admins can manage funding sources -->
    <record id="rule_funding_source_admin" model="ir.rule">
        <field name="name">Execution Funding Source: Admin Full Access</field>
        <field name="model_id" ref="model_execution_funding_source"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_admin'))]"/>
    </record>

    <!-- ================================================================
         RECORD RULES - Projects
    ================================================================= -->
    
    <!-- Users can see projects they are assigned to or created -->
    <record id="rule_project_user" model="ir.rule">
        <field name="name">Execution Project: User Own Projects</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[
            '|', '|', '|',
            ('user_id', '=', user.id),
            ('create_uid', '=', user.id),
            ('message_partner_ids', 'in', [user.partner_id.id]),
            ('privacy_visibility', '=', 'portal')
        ]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_base'))]"/>
    </record>

    <!-- Managers can see all projects -->
    <record id="rule_project_manager" model="ir.rule">
        <field name="name">Execution Project: Manager Full Access</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="True"/>
        <field name="perm_create" eval="True"/>
        <field name="perm_unlink" eval="True"/>
        <field name="groups" eval="[(4, ref('group_executionpm_pmo'))]"/>
    </record>


    <!-- ================================================================
         RECORD RULES - Workflow Restrictions
    ================================================================= -->

    <!-- Authority Group: Enforcement of Global Read-Only -->
    <record id="rule_authority_readonly_all" model="ir.rule">
        <field name="name">Authority: Global Read-Only Enforcement</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[(1, '=', 1)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_authority'))]"/>
    </record>

    <!-- Contractor: Can only see their own projects -->
    <record id="rule_project_contractor_own" model="ir.rule">
        <field name="name">Contractor: Own Projects Only</field>
        <field name="model_id" ref="project.model_project_project"/>
        <field name="domain_force">[('execution_contractor_id.user_ids', 'in', user.id)]</field>
        <field name="perm_read" eval="True"/>
        <field name="perm_write" eval="False"/>
        <field name="perm_create" eval="False"/>
        <field name="perm_unlink" eval="False"/>
        <field name="groups" eval="[(4, ref('group_executionpm_contractor'))]"/>
    </record>

</odoo>
